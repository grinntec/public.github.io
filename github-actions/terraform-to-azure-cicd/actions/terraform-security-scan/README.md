# Terraform Security Scan (Checkov) GitHub Action

This composite GitHub Action runs [Checkov](https://www.checkov.io/) against your Terraform **plan JSON** to detect misconfigurations, security issues, and compliance violations before you deploy to Azure. Designed for use in modular CI/CD pipelines, it provides detailed Markdown summaries in the Actions UI for easy review and auditability.

---

## Features

- **Automated security scanning:**  
  Runs Checkov against your Terraform plan JSON file (`tfplan.json`), ensuring you catch issues in the resolved infrastructure—not just the source code.
- **Actionable reporting:**  
  Outputs a Markdown summary with a concise status and an expandable section showing full Checkov results.
- **Fast fail:**  
  If Checkov finds critical issues, the workflow fails immediately to prevent insecure deployments.
- **Workflow-friendly:**  
  Designed to plug into matrix jobs and multi-directory setups; works with plans generated by upstream steps.
- **Traceable:**  
  All step outputs and error conditions are captured for audit trails.

---

## Usage

Add this action after you have generated a Terraform plan and exported a plan JSON:

```yaml
- name: Terraform Plan
  uses: ./.github/actions/terraform-plan
  with:
    file: environments/dev/terraform.tfvars

- name: Terraform Security Scan
  uses: ./.github/actions/terraform-security-scan
  with:
    file: environments/dev/terraform.tfvars
    author_name: github-actions[bot]
    author_email: github-actions[bot]@users.noreply.github.com
```

**Typical workflow context:**

```yaml
jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Terraform Plan
        uses: ./.github/actions/terraform-plan
        with:
          file: environments/dev/terraform.tfvars
      - name: Terraform Security Scan
        uses: ./.github/actions/terraform-security-scan
        with:
          file: environments/dev/terraform.tfvars
          author_name: github-actions[bot]
          author_email: github-actions[bot]@users.noreply.github.com
```

---

## Inputs

| Name         | Description                               | Required | Example                                   |
|--------------|-------------------------------------------|----------|-------------------------------------------|
| file         | Path to the `.tfvars` file                | Yes      | `environments/dev/terraform.tfvars`       |
| author_name  | Author name for reporting                 | Yes      | `github-actions[bot]`                     |
| author_email | Author email for reporting                | Yes      | `github-actions[bot]@users.noreply.github.com` |

---

## Prerequisites

- **Terraform plan JSON**  
  This action expects a corresponding `tfplan.json` file in the same directory as the `.tfvars` file.
- **Checkov installed**  
  The action will install the required version automatically from its `requirements.txt`.

---

## How It Works

1. **Directory detection:**  
   Uses the directory of the provided `.tfvars` file.
2. **Validates required files:**  
   Checks for the presence of both `tfplan` and `tfplan.json` in the directory.
3. **Runs Checkov:**  
   Scans the plan JSON for security and compliance issues.
4. **Markdown summary:**  
   Writes a concise status and a collapsible section with verbose output to the Actions UI.
5. **Fast fail:**  
   If Checkov finds errors, the workflow fails and blocks unsafe deployments.

---

## Example Output

If Checkov passes, you’ll see:

```
## Checkov Security Scan (Terraform Plan)
✅ Succeeded

> Checkov scanned your Terraform plan (resolved resources) for misconfigurations and security issues.
> If errors are found, review the findings below and fix all critical issues before deploying.

<details><summary>Show Checkov verbose output</summary>
``` 
[Checkov output]
```
</details>
```

If issues are found or the scan fails, the summary will indicate failure and show the output.

---

## Best Practices

- Always run this action after generating your plan JSON, but before deployment.
- Fix all critical findings before merging or applying infrastructure changes.
- Use matrix jobs to scan every changed environment or directory.
- Combine with other actions (lint, validate, cost estimate) for robust, secure pipelines.

---

## Limitations

- Only scans the plan JSON; does not check raw `.tf` files (use TFLint or similar for static code scanning).
- Requires the plan and plan JSON to be present in the same directory as the `.tfvars` file.
- Fails the workflow if Checkov finds critical issues—review and resolve before retrying.

---

## References

- [Checkov Documentation](https://www.checkov.io/)
- [Terraform Plan JSON](https://developer.hashicorp.com/terraform/cli/commands/show#json-output-format)

---

## License

[MIT License](../LICENSE) © 2025 Grinntec

---
